<?xml version="1.0" encoding="UTF-8"?>
<files>
    <% 
    def entityRef = [:]
    mapper.entity.each { entityRef[it.id] = it }
    entityRef.each {
    id, entity ->
    def pkg    = fn.pkg(groupId, artifactId, module);  
    def clazz  = fn.deduce(entity.clazz)
    def data   = fn.deduceName(entity.clazz)
    def filter = fn.deduceName(entity.clazz, 'Filter')
    def serv   = fn.deduceName(entity.clazz, 'Serv')
    def impl   = fn.deduceName(entity.clazz, 'Impl')
    def func   = fn.deduceName(entity.clazz, 'Func')
    def local  = fn.deduceName(entity.clazz, 'Local')
    def validate  = fn.deduceName(entity.clazz, 'Validate')
    def attr   = []
    attr.addAll(entity.attributes.id.collect{fn.deduceAttrName(it)})
    attr.addAll(entity.attributes.basic.collect{fn.deduceAttrName(it)})
    attr.addAll(entity.attributes.oneToMany.collect{fn.deduceRefName(it, entityRef)})
    attr.addAll(entity.attributes.oneToOne.collect{fn.deduceRefName(it, entityRef)})
    attr.addAll(entity.attributes.manyToOne.collect{fn.deduceRefName(it, entityRef)})
    %>
    <file name="${local.type}.java" layer="local" dir="." pkg="${pkg}">
<![CDATA[
import bo.central.result.ResultObject;
import bo.central.result.ResultSet;
import bo.central.filter.FilterBuilder;
import bo.central.Filter;
import java.util.List;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import java.util.stream.Stream;
import bo.gob.bcb.grh.postulate.modelo.${entity.clazz};

@Stateless
@LocalBean
public class ${local.type} {

    @PersistenceContext(unitName = "form-store")
    private EntityManager em;

    public ${local.type}() {
    }

    public ${local.type}(EntityManager em) {
        this.em = em;
    }

    public Stream<${clazz.type}> filter${data.type}Stream(Filter filter) {
        return FilterBuilder.create(${clazz.type}.class, filter).executeStream(em);
    }

    public ResultSet<${clazz.type}> filter${data.type}(Filter filter) {
        ResultSet<${clazz.type}> result = new ResultSet();
        List<${clazz.type}> list = FilterBuilder.create(${clazz.type}.class, filter).executeQuery(em);
        result.setValue(list);
        return result;
    }

    public ResultObject<${clazz.type}> search${data.type}(Long id) {
        ${clazz.type} ${data.var} = em.find(${clazz.type}.class, id);
        return ResultObject.of(${data.var}, ${data.var} == null);
    }

    public ResultObject<${clazz.type}> create${data.type}(${clazz.type} ${data.var}) {
        ResultObject<${clazz.type}> result = ${validate.type}.validateCreate${data.type}(${data.var});
        if (result.hasError()) {
            return result;
        }
        em.persist(${data.var});
        result.setValue(${data.var});
        result.addMessage("El ${data.text} fue registrado correctamente").type("INFO").action("Puede proceder a realizar mas operaciones");
        return result;
    }

    public ResultObject<${clazz.type}> update${data.type}(${clazz.type} ${data.var}) {
        ResultObject<${clazz.type}> result = ${validate.type}.validateUpdate${data.type}(${data.var});
        if (result.hasError()) {
            return result;
        }
        em.persist(${data.var});
        result.setValue(${data.var});
        result.addMessage("El ${data.text} fue actualizado correctamente").type("INFO").action("Puede proceder a realizar mas operaciones");
        return result;
    }

    public ResultObject<${clazz.type}> remove${data.type}(Long id) {
        ${clazz.type} ${data.var} = em.find(${clazz.type}.class, id);
        return remove${data.type}(${data.var});
    }

    public ResultObject<${clazz.type}> remove${data.type}(${clazz.type} ${data.var}) {
        ResultObject<${clazz.type}> result = ${validate.type}.validateRemove${data.type}(${data.var});
        if (result.hasError()) {
            return result;
        }
        em.remove(${data.var});
        result.setValue(${data.var});
        result.addMessage("El ${data.text} fue eliminado correctamente").type("INFO").action("Puede proceder a realizar mas operaciones");
        return result;
    }
}
]]></file>
    <file name="${validate.type}.java" layer="local:validate" dir="." pkg="${pkg}">
<![CDATA[
import java.util.List;
import bo.central.result.ResultObject;
import bo.central.result.Message;
import bo.central.validate.Validate;
import bo.gob.bcb.grh.postulate.modelo.${entity.clazz};

public class ${validate.type} {

    static ResultObject validateCreate${data.type}(${clazz.type} ${data.var}) {
        ResultObject result = new ResultObject<>();
        Message message = Message.of("WARN", "Validacion Creacion ${data.text}");
        if (${data.var} == null) {
            message.addCause("El objeto es NULL");
        } else {
            message.addCause(${data.var}.getId() != null, "Id no valido!");
            validateContent(${data.var}, message);
        }
        if(message.hasCause()){
            result.addMessage(message);
            result.setError(true);
        }
        return result;
        
    }

    static ResultObject validateUpdate${data.type}(${clazz.type} ${data.var}) {
        ResultObject result = new ResultObject<>();
        Message message = Message.of("WARN", "Validacion Actualizacion ${data.text}");
        if (${data.var} == null) {
            message.addCause("El objeto es NULL");
        } else {
            message.addCause(${data.var}.getId() == null, "Id no valido!");
            validateContent(${data.var}, message);
        }
        if (message.hasCause()) {
            result.addMessage(message);
            result.setError(true);
        }
        return result;
    }

    static ResultObject validateRemove${data.type}(${clazz.type} ${data.var}) {
        ResultObject result = new ResultObject<>();
        Message message = Message.of("WARN", "Validacion Eliminacion ${data.text}");
        if (${data.var} == null) {
            message.addCause("El objeto es NULL");
        } else {
            message.addCause(${data.var}.getId() != null, "Id no valido!");
        }
        if (message.hasCause()) {
            result.addMessage(message);
            result.setError(true);
        }
        return result;
    }

    private static void validateContent(${clazz.type} entity, Message message) {
        List<String> causes =  Validate.create(${clazz.type}.class)
                <% attr.each{  %>
                   //.isRequired("${it.text}",  ${clazz.type}::${it.get})<% } %>
                .apply(entity, "${data.text}");
       message.addCauses(causes);
    }
}
]]></file>
    <% } %>
</files>
